{% extends "base.html" %}

{% block title %}{{ post.title }} - BlogSphere{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Post Content -->
        <div class="card mb-4">
            <div class="card-body">
                <h1 class="card-title">{{ post.title }}</h1>
                
                <div class="author-info mb-3">
                    <i class="fas fa-user"></i> {{ post.author.username }}
                    <span class="mx-2">â€¢</span>
                    <i class="fas fa-clock"></i> {{ post.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                </div>
                
                <div class="post-content">
                    {{ post.content|replace('\n', '<br>')|safe }}
                </div>
                
                <div class="post-actions mt-4 d-flex justify-content-between align-items-center">
                    <div class="d-flex gap-3">
                        <button class="btn btn-outline-danger like-btn" data-post-id="{{ post.id }}">
                            <i class="fas fa-heart"></i>
                            <span class="like-count">{{ post.like_count }}</span>
                        </button>
                        
                        <button class="btn btn-outline-primary" onclick="scrollToComments()">
                            <i class="fas fa-comment"></i>
                            <span class="comment-count">{{ post.comment_count }}</span>
                        </button>
                    </div>
                    
                    {% if current_user and current_user.id == post.user_id %}
                    <div class="btn-group">
                        <a href="{{ url_for('edit_post', post_id=post.id) }}" class="btn btn-outline-secondary">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                        <button class="btn btn-outline-danger" onclick="deletePost({{ post.id }})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Comments Section -->
        <div class="card" id="comments-section">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-comments"></i> Comments 
                    <span class="badge bg-primary">{{ post.comment_count }}</span>
                </h5>
            </div>
            <div class="card-body">
                {% if current_user %}
                <!-- Add Comment Form -->
                <form id="comment-form" class="mb-4" data-post-id="{{ post.id }}">
                    <div class="mb-3">
                        <textarea class="form-control" id="comment-content" rows="3" placeholder="Share your thoughts..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Add Comment
                    </button>
                </form>
                <hr>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    <a href="{{ url_for('login') }}" class="alert-link">Login</a> to add comments.
                </div>
                {% endif %}
                
                <!-- Comments List -->
                <div class="comment-section" id="comments-list">
                    {% for comment in post.comments %}
                    <div class="comment-item" id="comment-{{ comment.id }}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ comment.author.username }}</strong>
                                <small class="text-muted ms-2">{{ comment.created_at.strftime('%B %d, %Y at %I:%M %p') }}</small>
                                <p class="mt-2 mb-0">{{ comment.content|replace('\n', '<br>')|safe }}</p>
                            </div>
                            
                            {% if current_user and (current_user.id == comment.user_id or current_user.id == post.user_id) %}
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteComment({{ comment.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    
                    {% if not post.comments %}
                    <div class="text-center py-4">
                        <i class="fas fa-comment-slash fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No comments yet. Be the first to share your thoughts!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Author Info -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">About the Author</h5>
            </div>
            <div class="card-body text-center">
                <i class="fas fa-user-circle fa-3x text-muted mb-3"></i>
                <h6>{{ post.author.username }}</h6>
                <p class="text-muted small">Member since {{ post.author.posts[0].created_at.strftime('%B %Y') if post.author.posts else 'Unknown' }}</p>
                
                <div class="row text-center mt-3">
                    <div class="col-6">
                        <h6 class="text-primary">{{ post.author.posts|length }}</h6>
                        <small class="text-muted">Posts</small>
                    </div>
                    <div class="col-6">
                        <h6 class="text-success">{{ post.author.comments|length }}</h6>
                        <small class="text-muted">Comments</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Related Posts -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Recent Posts</h5>
            </div>
            <div class="card-body">
                {% for recent_post in post.author.posts[:3] %}
                    {% if recent_post.id != post.id %}
                    <div class="mb-3">
                        <h6 class="mb-1">
                            <a href="{{ url_for('view_post', post_id=recent_post.id) }}" class="text-decoration-none">
                                {{ recent_post.title[:50] }}{% if recent_post.title|length > 50 %}...{% endif %}
                            </a>
                        </h6>
                        <small class="text-muted">{{ recent_post.created_at.strftime('%B %d, %Y') }}</small>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Set up comment form with post ID
    $('#comment-form').attr('data-post-id', {{ post.id }});
    
    // Initialize post-specific functionality
    const postId = {{ post.id }};
    
    // Add post-specific event handlers
    $('.like-btn[data-post-id="' + postId + '"]').on('click', function() {
        toggleLike(postId);
    });
});
</script>
{% endblock %}
